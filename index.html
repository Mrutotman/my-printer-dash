<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Smart 3D Printer Dash - SECURE CLOUD</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', Arial; margin: 0; background-color: #f4f4f9; display: flex; flex-direction: column; height: 100vh; }
    
    /* Login Gatekeeper Styling */
    #auth-overlay {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: #1a1a1a;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      z-index: 10000;
      color: white;
    }
    .auth-box { background: #333; padding: 30px; border-radius: 12px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.5); border: 1px solid #444; width: 300px; }
    .auth-input { padding: 12px; font-size: 14px; border-radius: 6px; border: 1px solid #555; width: 90%; margin-bottom: 10px; text-align: center; background: #222; color: white; }
    .auth-btn { background: #4CAF50; color: white; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; }

    /* Loading Screen */
    #loading-screen {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: #333;
      display: none; flex-direction: column;
      align-items: center; justify-content: center;
      z-index: 9999;
      color: white;
    }
    .spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top: 4px solid #4CAF50; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 20px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* Layout Styling */
    header { background: #333; color: white; padding: 10px 20px; text-align: left; }
    .main-container { display: flex; flex: 1; overflow: hidden; padding: 15px; gap: 20px; }
    .sidebar { width: 40%; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
    .monitoring { width: 60%; display: flex; flex-direction: column; gap: 15px; }
    .section { background: white; border-radius: 12px; padding: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .relay-card { border: 1px solid #eee; padding: 10px; border-radius: 8px; background: #fafafa; text-align: center; }
    .btn { font-size: 13px; padding: 10px; margin-top: 8px; border: none; border-radius: 6px; cursor: pointer; width: 100%; font-weight: bold; }
    .on { background-color: #4CAF50; color: white; }
    .off { background-color: #f44336; color: white; }
    .status-text { font-weight: bold; font-size: 14px; }
    .green { color: #2e7d32; }
    .red { color: #c62828; }
    
    .test-readout { display: flex; justify-content: space-around; padding: 15px 0; text-align: center; }
    .test-val { font-size: 28px; font-weight: bold; color: #333; }
    .test-label { font-size: 11px; color: #777; text-transform: uppercase; margin-top: 5px; }
    #cloud-bar { background: #222; color: #00ff00; font-size: 11px; padding: 3px 20px; text-align: right; }
  </style>
</head>
<body>

  <div id="auth-overlay">
    <div class="auth-box">
      <h2>ðŸ”’ Secure Login</h2>
      <p style="font-size: 12px; color: #aaa;">Enter HiveMQ Credentials</p>
      <input type="text" id="mqtt-user" class="auth-input" placeholder="HiveMQ Username">
      <input type="password" id="mqtt-pass" class="auth-input" placeholder="HiveMQ Password">
      <button class="auth-btn" onclick="attemptLogin()">CONNECT TO FARM</button>
    </div>
  </div>

  <div id="loading-screen">
    <div class="spinner"></div>
    <div id="loading-text">Connecting...</div>
  </div>

  <div id="main-content" style="display: none;">
    <div id="cloud-bar">SYNCING...</div>
    <header><h2>SMART 3D PRINTER DASHBOARD (GLOBAL)</h2></header>

    <div class="main-container">
      <div class="sidebar">
        <div class="section">
          <h3>MASTER POWER</h3>
          <p>Status: <span id="relay9_status" class="status-text red">OFF</span></p>
          <button id="relay9_btn" class="btn on" onclick="handleRelayAction(9)">TURN MASTER ON</button>
        </div>
        <div class="section">
          <h3>CONTROL PANEL</h3>
          <div class="grid" id="relay-container"></div>
        </div>
      </div>

      <div class="monitoring">
        <div class="section">
          <h3>ENERGY MONITORING (PZEM - DHT TEST)</h3>
          <div class="test-readout">
            <div><div id="temp-display" class="test-val">--Â°C</div><div class="test-label">Temperature</div></div>
            <div style="width: 1px; background: #eee;"></div>
            <div><div id="humi-display" class="test-val">--%</div><div class="test-label">Humidity</div></div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
const MQTT_HOST = "143fa294384e4a2fa42c7bfe8a7ebd1d.s1.eu.hivemq.cloud";
const MQTT_PORT = 8884;
const CLIENT_ID = "web_ui_" + Math.random().toString(16).substr(2, 8);
let client = null;

function attemptLogin() {
  const user = document.getElementById('mqtt-user').value;
  const pass = document.getElementById('mqtt-pass').value;

  if (!user || !pass) {
    alert("Credentials required!");
    return;
  }

  document.getElementById('loading-screen').style.display = 'flex';
  initMQTT(user, pass);
}

function initMQTT(u, p) {
  client = new Paho.MQTT.Client("wss://" + MQTT_HOST + ":" + MQTT_PORT + "/mqtt", CLIENT_ID);

  client.onMessageArrived = (message) => {
    try {
      const data = JSON.parse(message.payloadString);
      if(data.relays) data.relays.forEach((state, index) => updateUI(index + 1, state));
      if(data.hasOwnProperty('master')) updateUI(9, data.master);
      if(data.hasOwnProperty('temp')) document.getElementById('temp-display').innerText = data.temp.toFixed(1) + "Â°C";
      if(data.hasOwnProperty('humi')) document.getElementById('humi-display').innerText = data.humi.toFixed(1) + "%";
      hideLoading();
    } catch(e) { console.error(e); }
  };

  client.connect({
    useSSL: true, userName: u, password: p,
    onSuccess: () => {
      document.getElementById('auth-overlay').style.display = 'none';
      document.getElementById('main-content').style.display = 'block';
      document.getElementById('cloud-bar').innerText = "GLOBAL CLOUD: CONNECTED";
      client.subscribe("/printer_01/status");
      setTimeout(hideLoading, 2000);
    },
    onFailure: (err) => {
      alert("Login Failed: Check HiveMQ Credentials");
      document.getElementById('loading-screen').style.display = 'none';
    }
  });
}

function hideLoading() {
  const loader = document.getElementById('loading-screen');
  loader.style.opacity = '0';
  setTimeout(() => loader.style.display = 'none', 500);
}

// UI Generation & Actions
const container = document.getElementById('relay-container');
const labels = ["Printer 1", "Printer 2", "Printer 3", "Printer 4", "Free 1", "Free 2", "LED Light", "Spare"];
for (let i = 1; i <= 8; i++) {
  container.innerHTML += `
    <div class="relay-card">
      <small style="color: #666;">${labels[i-1]}</small><br>
      <span id="relay${i}_status" class="status-text red">OFF</span><br>
      <button id="relay${i}_btn" class="btn on" onclick="handleRelayAction(${i})">ON</button>
    </div>`;
}

function handleRelayAction(id) {
  const statusEl = document.getElementById(`relay${id}_status`);
  const isCurrentlyOn = statusEl.innerText.includes("ON");
  const msg = new Paho.MQTT.Message(JSON.stringify({relay: id, state: isCurrentlyOn ? 0 : 1}));
  msg.destinationName = "/printer_01/commands";
  client.send(msg);
}

function updateUI(id, state) {
  const statusEl = document.getElementById(`relay${id}_status`);
  const btnEl = document.getElementById(`relay${id}_btn`);
  if(!statusEl || !btnEl) return;
  
  if (state == 1) {
    statusEl.innerHTML = "ON"; statusEl.className = "status-text green";
    btnEl.innerHTML = "TURN OFF"; btnEl.className = "btn off";
  } else {
    statusEl.innerHTML = "OFF"; statusEl.className = "status-text red";
    btnEl.innerHTML = "TURN ON"; btnEl.className = "btn on";
  }
}
</script>
</body>
</html>
