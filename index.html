<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Smart 3D Printer Dash - GLOBAL SECURE</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
  <style>
    :root { --primary-green: #4CAF50; --error-red: #f44336; --dark-bg: #1a1a1a; --card-bg: #ffffff; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background-color: #f0f2f5; display: flex; flex-direction: column; height: 100vh; color: #333; }
    
    /* Auth Overlay */
    #auth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--dark-bg); display: flex; align-items: center; justify-content: center; z-index: 10000; }
    .auth-box { background: #2d2d2d; padding: 40px; border-radius: 16px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.4); width: 320px; color: white; }
    .auth-input { padding: 12px; font-size: 14px; border-radius: 8px; border: 1px solid #444; width: 100%; margin-bottom: 12px; box-sizing: border-box; background: #1a1a1a; color: white; }
    .auth-check { margin-bottom: 20px; display: flex; align-items: center; justify-content: center; font-size: 13px; color: #bbb; gap: 8px; }
    .auth-btn { background: var(--primary-green); color: white; padding: 14px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; transition: 0.3s; }
    .auth-btn:hover { background: #45a049; transform: translateY(-1px); }

    /* Layout & Header */
    header { background: #333; color: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    #cloud-bar { font-size: 11px; color: #00ff00; letter-spacing: 1px; }
    .main-container { display: flex; flex: 1; overflow: hidden; padding: 20px; gap: 20px; }
    .sidebar { width: 35%; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; }
    .monitoring { width: 65%; display: flex; flex-direction: column; gap: 20px; }
    
    /* Sections & Grid */
    .section { background: var(--card-bg); border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    h3 { margin-top: 0; font-size: 16px; color: #555; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
    .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
    .relay-card { border: 1px solid #f0f0f0; padding: 15px; border-radius: 10px; background: #fafafa; text-align: center; transition: 0.2s; }
    .relay-card:hover { border-color: #ddd; }
    
    /* Buttons & Status */
    .btn { font-size: 12px; padding: 10px; margin-top: 10px; border: none; border-radius: 6px; cursor: pointer; width: 100%; font-weight: bold; text-transform: uppercase; transition: 0.3s; }
    .on { background-color: #e8f5e9; color: var(--primary-green); border: 1px solid var(--primary-green); }
    .off { background-color: #ffebee; color: var(--error-red); border: 1px solid var(--error-red); }
    .status-text { font-weight: bold; font-size: 13px; }
    .green { color: var(--primary-green); }
    .red { color: var(--error-red); }

    /* Monitoring UI */
    .test-readout { display: flex; justify-content: space-around; padding: 10px 0; }
    .test-val { font-size: 32px; font-weight: bold; color: #333; }
    .test-label { font-size: 11px; color: #888; text-transform: uppercase; margin-top: 4px; }
    .placeholder { border: 2px dashed #ddd; color: #aaa; display: flex; align-items: center; justify-content: center; min-height: 250px; border-radius: 10px; font-style: italic; background: #fdfdfd; }
    
    #logout-btn { background: none; border: 1px solid #666; color: #ccc; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 10px; }
  </style>
</head>
<body>

  <div id="auth-overlay">
    <div class="auth-box">
      <h2 style="margin-top:0">Farm Access</h2>
      <p style="font-size: 12px; color: #888; margin-bottom:20px">Credentials are never stored on GitHub</p>
      <input type="text" id="mqtt-user" class="auth-input" placeholder="HiveMQ Username">
      <input type="password" id="mqtt-pass" class="auth-input" placeholder="HiveMQ Password">
      <div class="auth-check">
        <input type="checkbox" id="remember-me"> <label for="remember-me">Remember this device</label>
      </div>
      <button class="auth-btn" onclick="attemptLogin()">CONNECT GLOBALLY</button>
    </div>
  </div>

  <div id="main-content" style="display: none;">
    <header>
      <div>
        <h2 style="margin:0; font-size: 18px;">PRINTER FARM CONTROL</h2>
        <div id="cloud-bar">SYNCING WITH HIVEMQ...</div>
      </div>
      <button id="logout-btn" onclick="logout()">LOGOUT / CLEAR CACHE</button>
    </header>

    <div class="main-container">
      <div class="sidebar">
        <div class="section">
          <h3>MASTER POWER</h3>
          <p>System Status: <span id="relay9_status" class="status-text red">OFF</span></p>
          <button id="relay9_btn" class="btn on" onclick="handleRelayAction(9)">TURN MASTER ON</button>
        </div>
        <div class="section">
          <h3>CONTROL PANEL</h3>
          <div class="grid" id="relay-container"></div>
        </div>
      </div>

      <div class="monitoring">
        <div class="section">
          <h3>CAMERA FEED</h3>
          <div class="placeholder">Awaiting RTSP/Stream Source...</div>
        </div>
        <div class="section">
          <h3>TELEMETRY (DHT11 SENSOR)</h3>
          <div class="test-readout">
            <div><div id="temp-display" class="test-val">--°C</div><div class="test-label">Temperature</div></div>
            <div style="width: 1px; background: #eee;"></div>
            <div><div id="humi-display" class="test-val">--%</div><div class="test-label">Humidity</div></div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
const MQTT_HOST = "143fa294384e4a2fa42c7bfe8a7ebd1d.s1.eu.hivemq.cloud";
const MQTT_PORT = 8884;
const CLIENT_ID = "web_ui_" + Math.random().toString(16).substr(2, 8);
let client = null;

// AUTO-LOGIN LOGIC
window.onload = () => {
  const savedUser = localStorage.getItem('mqtt_user');
  const savedPass = localStorage.getItem('mqtt_pass');
  if (savedUser && savedPass) {
    document.getElementById('mqtt-user').value = savedUser;
    document.getElementById('mqtt-pass').value = savedPass;
    document.getElementById('remember-me').checked = true;
    attemptLogin();
  }
};

function attemptLogin() {
  const user = document.getElementById('mqtt-user').value;
  const pass = document.getElementById('mqtt-pass').value;
  const remember = document.getElementById('remember-me').checked;

  if (!user || !pass) return alert("Credentials required!");

  if (remember) {
    localStorage.setItem('mqtt_user', user);
    localStorage.setItem('mqtt_pass', pass);
  }

  initMQTT(user, pass);
}

function logout() {
  localStorage.clear();
  location.reload();
}

function initMQTT(u, p) {
  client = new Paho.MQTT.Client("wss://" + MQTT_HOST + ":" + MQTT_PORT + "/mqtt", CLIENT_ID);

  client.onMessageArrived = (message) => {
    try {
      const data = JSON.parse(message.payloadString);
      if(data.relays) data.relays.forEach((state, index) => updateUI(index + 1, state));
      if(data.hasOwnProperty('master')) updateUI(9, data.master);
      if(data.hasOwnProperty('temp')) document.getElementById('temp-display').innerText = data.temp.toFixed(1) + "°C";
      if(data.hasOwnProperty('humi')) document.getElementById('humi-display').innerText = data.humi.toFixed(1) + "%";
    } catch(e) {}
  };

  client.connect({
    useSSL: true, userName: u, password: p,
    onSuccess: () => {
      document.getElementById('auth-overlay').style.display = 'none';
      document.getElementById('main-content').style.display = 'block';
      document.getElementById('cloud-bar').innerText = "• CLOUD ONLINE";
      client.subscribe("/printer_01/status");
    },
    onFailure: () => {
      alert("Invalid Credentials");
      logout();
    }
  });
}

// UI Setup & Handlers
const container = document.getElementById('relay-container');
const labels = ["Printer 1", "Printer 2", "Printer 3", "Printer 4", "Free 1", "Free 2", "LED", "Spare"];
for (let i = 1; i <= 8; i++) {
  container.innerHTML += `
    <div class="relay-card">
      <small style="color: #999; font-weight:bold">${labels[i-1]}</small><br>
      <span id="relay${i}_status" class="status-text red">OFF</span><br>
      <button id="relay${i}_btn" class="btn on" onclick="handleRelayAction(${i})">ON</button>
    </div>`;
}

function handleRelayAction(id) {
  const statusEl = document.getElementById(`relay${id}_status`);
  const isCurrentlyOn = statusEl.innerText.includes("ON");
  const msg = new Paho.MQTT.Message(JSON.stringify({relay: id, state: isCurrentlyOn ? 0 : 1}));
  msg.destinationName = "/printer_01/commands";
  client.send(msg);
}

function updateUI(id, state) {
  const statusEl = document.getElementById(`relay${id}_status`);
  const btnEl = document.getElementById(`relay${id}_btn`);
  if(!statusEl || !btnEl) return;
  
  if (state == 1) {
    statusEl.innerHTML = "ON"; statusEl.className = "status-text green";
    btnEl.innerHTML = "OFF"; btnEl.className = "btn off";
  } else {
    statusEl.innerHTML = "OFF"; statusEl.className = "status-text red";
    btnEl.innerHTML = "ON"; btnEl.className = "btn on";
  }
}
</script>
</body>
</html>
