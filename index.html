<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Mezza Control</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
  <style>
    /* --- CSS STYLES --- */
    :root { --primary: #4CAF50; --danger: #f44336; --dark: #1a1a1a; --light: #ffffff; --grey: #bbb; }
    body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f0f2f5; display: flex; flex-direction: column; height: 100vh; overflow-x: hidden; }
    
    /* Login Overlay */
    #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--dark); display: flex; align-items: center; justify-content: center; z-index: 99999; }
    .login-box { background: #2d2d2d; padding: 30px; border-radius: 12px; width: 300px; text-align: center; color: white; }
    .input-field { width: 100%; padding: 10px; margin: 5px 0; border-radius: 5px; border: 1px solid #555; background: #111; color: white; box-sizing: border-box; }
    .action-btn { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; margin-top: 10px; }
    
    /* Layout */
    .header { background: #333; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
    .container { display: flex; flex: 1; padding: 15px; gap: 15px; overflow-y: auto; flex-wrap: wrap; margin-bottom: 60px; }
    .sidebar { width: 30%; min-width: 280px; display: flex; flex-direction: column; gap: 15px; }
    .main-content { flex: 1; min-width: 300px; display: flex; flex-direction: column; gap: 15px; }
    
    .card { background: var(--light); padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    h3 { margin: 0 0 10px 0; font-size: 14px; color: #666; border-bottom: 1px solid #eee; padding-bottom: 5px; }
    
    /* Controls */
    .disabled { opacity: 0.5; pointer-events: none; filter: grayscale(100%); }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .relay-item { border: 1px solid #eee; padding: 10px; border-radius: 8px; text-align: center; background: #fafafa; }
    .led { width: 10px; height: 10px; border-radius: 50%; background: var(--grey); display: inline-block; margin-right: 5px; }
    .led.on { background: var(--primary); box-shadow: 0 0 8px var(--primary); }
    
    .btn { width: 100%; padding: 8px; margin-top: 5px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 11px; }
    .btn-on { background: #e8f5e9; color: var(--primary); border: 1px solid var(--primary); }
    .btn-off { background: #ffebee; color: var(--danger); border: 1px solid var(--danger); }

    /* Monitoring */
    .camera-box { background: black; width: 100%; aspect-ratio: 16/9; max-height: 350px; display: flex; align-items: center; justify-content: center; color: #555; border-radius: 8px; position: relative; overflow: hidden; }
    .pzem-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; text-align: center; }
    .pzem-val { font-size: 18px; font-weight: bold; }
    .pzem-label { font-size: 10px; color: #888; }

    /* Slider UI */
    .slider-container {
        position: absolute; bottom: 10px; left: 10px; right: 10px;
        background: rgba(0,0,0,0.6); border-radius: 20px; padding: 5px 15px;
        display: flex; align-items: center; gap: 10px; backdrop-filter: blur(4px);
    }
    .slider-container span { color: white; font-size: 12px; font-weight: bold; }
    input[type=range] { width: 100%; cursor: pointer; accent-color: var(--primary); }
    
    .log-list { font-size: 11px; height: 150px; overflow-y: auto; border-top: 1px solid #eee; }
    .log-table { width: 100%; border-collapse: collapse; }
    .log-table th { text-align: left; background: #f9f9f9; padding: 5px; position: sticky; top: 0; }
    .log-table td { padding: 5px; border-bottom: 1px solid #eee; color: #555; }

    /* Modals */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; align-items: center; justify-content: center; }
    .modal-box { background: white; padding: 25px; border-radius: 10px; width: 300px; text-align: center; }
    
    /* Config Button */
    #config-btn { position: fixed; bottom: 140px; left: 20px; width: 45px; height: 45px; border-radius: 50%; background: #555; color: white; font-weight: bold; font-size: 20px; border: 1px solid #777; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.4); z-index: 99999; }

    #help-btn { position: fixed; bottom: 80px; left: 20px; width: 45px; height: 45px; border-radius: 50%; background: #333; color: white; font-weight: bold; font-size: 20px; border: 1px solid #555; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.4); z-index: 99999; transition: 0.3s; }
    #help-btn:active { transform: scale(0.9); }

    footer { position: fixed; bottom: 0; width: 100%; background: #333; color: white; padding: 15px 0; display: flex; justify-content: space-around; font-size: 12px; }

    @media (max-width: 700px) {
      .container { flex-direction: column; }
      .sidebar, .main-content { width: 100%; }
      #help-btn { bottom: 90px; left: 15px; } 
      #config-btn { bottom: 150px; left: 15px; }
    }
  </style>
</head>
<body>

  <div id="login-overlay">
    <div class="login-box">
      <h2>SYSTEM LOGIN</h2>
      <input type="text" id="mqtt-user" class="input-field" placeholder="HiveMQ Username">
      <input type="password" id="mqtt-pass" class="input-field" placeholder="HiveMQ Password">
      <hr style="border: 0; border-top: 1px solid #444; margin: 15px 0;">
      <input type="text" id="device-name" class="input-field" placeholder="Device Name (e.g. Red's Phone)">
      
      <div style="font-size:12px; text-align:left; margin-top:5px;">
        <input type="checkbox" id="remember-me"> Remember Me
      </div>
      <button class="action-btn" onclick="connectSystem()">CONNECT</button>
    </div>
  </div>

  <div id="dashboard" style="display:none;">
    <header class="header">
      <strong>SMART MEZZA CONTROL</strong>
      <div style="font-size:11px;">
        <span id="display-name" style="color:#aaa; margin-right:10px;">Unknown Device</span>
        <button onclick="doLogout()" style="background:none; border:1px solid #666; color:#ccc; padding:5px 10px; cursor:pointer;">EXIT</button>
      </div>
    </header>

    <div class="container">
      <div class="sidebar">
        <div class="card">
          <h3>MASTER POWER (ID: 9)</h3>
          <div style="text-align:center; margin-bottom:10px;">
            <span id="led-9" class="led"></span> <b>System Bus</b>
          </div>
          <button id="btn-9" class="btn btn-on" onclick="handleClick(9)">TURN ON</button>
        </div>

        <div id="panel-lock" class="card disabled">
          <h3>CONTROL PANEL</h3>
          <div class="grid-2" id="relay-grid"></div>
        </div>
      </div>

      <div class="main-content">
        <div class="card">
          <h3>LIVE FEED</h3>
          <div class="camera-box">
            <iframe id="cam-stream" src="" 
                    style="width:100%; height:100%; border:none; transform: rotate(180deg);"
                    allow="autoplay">
            </iframe>
            
            <div id="cam-msg" style="position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; color:#555;">
                <span id="cam-status-text" style="font-size:16px; font-weight:bold;">WAITING FOR URL...</span>
                <span style="font-size:10px;">Click ‚öôÔ∏è to set Ngrok Link</span>
            </div>

            <div class="slider-container">
                <span>üí°</span>
                <input type="range" min="0" max="255" value="0" id="led-slider" oninput="updateLed(this.value)">
                <span id="led-val">0%</span>
            </div>
          </div>
        </div>

        <div class="card">
          <h3>POWER MONITOR</h3>
          <div class="pzem-grid">
            <div><div id="val-v" class="pzem-val">0</div><div class="pzem-label">VOLTS</div></div>
            <div><div id="val-a" class="pzem-val">0.00</div><div class="pzem-label">AMPS</div></div>
            <div><div id="val-w" class="pzem-val">0</div><div class="pzem-label">WATTS</div></div>
            <div><div id="val-wh" class="pzem-val">0.00</div><div class="pzem-label">Wh</div></div>
          </div>
        </div>

        <div class="card" style="flex:1;">
          <h3>ACTIVITY LOG</h3>
          <div class="log-list">
            <table class="log-table">
              <thead>
                <tr><th>Time</th><th>By</th><th>Action</th><th>Target</th></tr>
              </thead>
              <tbody id="log-body"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <button id="config-btn" onclick="openModal('config-modal')">‚öôÔ∏è</button>
    <button id="help-btn" onclick="openModal('tutorial-modal')">?</button>

    <footer>
      <span id="clock">--:--:--</span>
      <span>Temp: <b id="val-temp">--</b>¬∞C</span>
      <span>Humi: <b id="val-humi">--</b>%</span>
    </footer>
  </div>

  <div id="config-modal" class="modal-overlay">
    <div class="modal-box">
      <h3 style="color:#333;">CAMERA SETTINGS</h3>
      <p style="font-size:12px; color:#666;">Paste your new Ngrok link here:</p>
      <input type="text" id="ngrok-input" class="input-field" placeholder="https://xxxx.ngrok-free.app">
      <div style="display:flex; gap:10px; margin-top:15px;">
        <button class="btn btn-on" onclick="saveConfig()">SAVE & SYNC</button>
        <button class="btn btn-off" style="background:#ddd; color:#333; border:1px solid #ccc;" onclick="closeModal('config-modal')">CANCEL</button>
      </div>
    </div>
  </div>

  <div id="tutorial-modal" class="modal-overlay">
    <div class="modal-box">
      <h3 style="color:#333;">SYSTEM GUIDE</h3>
      <p style="font-size:13px; text-align:left;"><b>1. Update Camera:</b><br>Click ‚öôÔ∏è button and paste new Ngrok link.</p>
      <p style="font-size:13px; text-align:left;"><b>2. Control Panel:</b><br>Toggle individual devices. Locked if Master is OFF.</p>
      <button class="btn btn-on" onclick="closeModal('tutorial-modal')">GOT IT</button>
    </div>
  </div>

  <div id="confirm-modal" class="modal-overlay">
    <div class="modal-box">
      <h3 style="color:var(--danger)">‚ö†Ô∏è CONFIRM ACTION</h3>
      <p id="confirm-msg">Type CONFIRM to turn off.</p>
      <input type="text" id="confirm-input" class="input-field" style="text-align:center; color:black; background:#eee;" placeholder="Type CONFIRM">
      <div style="display:flex; gap:10px; margin-top:15px;">
        <button class="btn btn-off" onclick="executeOff()">CONFIRM OFF</button>
        <button class="btn btn-on" style="background:#ddd; color:#333; border:1px solid #ccc;" onclick="closeModal('confirm-modal')">CANCEL</button>
      </div>
    </div>
  </div>

<script>
// ================= CONFIGURATION =================
const MQTT_HOST = "143fa294384e4a2fa42c7bfe8a7ebd1d.s1.eu.hivemq.cloud";
const MQTT_PORT = 8884;
const CLIENT_ID = "web_" + Math.random().toString(16).substr(2, 8);
const LABELS = ["Printer 1", "Printer 2", "Printer 3", "Printer 4", "LED", "Free 1", "Free 2", "Free 3"];

// WE NO LONGER HARDCODE THE URL HERE!
let CURRENT_NGROK_URL = ""; 

let client = null;
let myDeviceName = "Unknown";
let deviceState = { 1:0, 2:0, 3:0, 4:0, 5:0, 6:0, 7:0, 8:0, 9:0 }; 
let pendingId = null; 
let pendingState = null;
let lockTimer = 0; 

// ================= INITIALIZATION =================
window.onload = () => {
  renderRelays();
  loadStoredLogs(); 

  const u = localStorage.getItem("mq_u");
  const p = localStorage.getItem("mq_p");
  const d = localStorage.getItem("mq_d"); 
  
  if(u && p) { 
    document.getElementById("mqtt-user").value = u;
    document.getElementById("mqtt-pass").value = p;
    if(d) document.getElementById("device-name").value = d;
    connectSystem();
  }
};

// ================= DYNAMIC CONFIG SYSTEM =================
function saveConfig() {
    let newUrl = document.getElementById("ngrok-input").value.trim();
    
    // Remove trailing slash if present
    if(newUrl.endsWith("/")) newUrl = newUrl.slice(0, -1);
    
    if(!newUrl.startsWith("https://")) {
        alert("Link must start with https://");
        return;
    }

    // Publish to HiveMQ (Retained) so it saves forever
    if(client && client.isConnected()) {
        const msg = new Paho.MQTT.Message(newUrl);
        msg.destinationName = "/printer_01/config/camera";
        msg.retained = true; // SAVE THIS ON SERVER
        client.send(msg);
        alert("Link Saved! All devices will update.");
        closeModal('config-modal');
    } else {
        alert("Not connected to System. Login first.");
    }
}

function updateCameraSource(baseUrl) {
    if(!baseUrl) return;
    CURRENT_NGROK_URL = baseUrl;
    const streamUrl = baseUrl + "/stream";
    console.log("Updating Stream to: " + streamUrl);
    document.getElementById("cam-stream").src = streamUrl;
    document.getElementById("cam-status-text").innerText = "CONNECTING...";
}

// ================= LED CONTROL (SYNCED) =================
function updateLed(val) {
    const percent = Math.round((val / 255) * 100);
    document.getElementById("led-val").innerText = percent + "%";

    // Only send HTTP if we have a URL
    if(CURRENT_NGROK_URL) {
        const ledUrl = CURRENT_NGROK_URL + "/led?val=" + val;
        fetch(ledUrl).catch(e => console.log("LED Error (Offline?)"));
    }

    if(client && client.isConnected()) {
        const payload = JSON.stringify({val: val, by: myDeviceName});
        const msg = new Paho.MQTT.Message(payload);
        msg.destinationName = "/printer_01/led";
        msg.retained = true; 
        client.send(msg);
    }
}

function handleCamError() {
  document.getElementById("cam-stream").style.display = 'none';
  const msgBox = document.getElementById("cam-msg");
  msgBox.style.display = 'flex';
  document.getElementById("cam-status-text").innerText = "STREAM OFFLINE";
}

function renderRelays() {
  const container = document.getElementById("relay-grid");
  container.innerHTML = "";
  LABELS.forEach((name, index) => {
    const id = index + 1;
    container.innerHTML += `
      <div class="relay-item">
        <div><span id="led-${id}" class="led"></span> <b>${name}</b></div>
        <button id="btn-${id}" class="btn btn-on" onclick="handleClick(${id})">TURN ON</button>
      </div>`;
  });
}

// ================= LOG SYSTEM (PERSISTENT) =================
function loadStoredLogs() {
    const stored = localStorage.getItem("activity_logs");
    if(stored) {
        try {
            const logs = JSON.parse(stored);
            logs.forEach(log => appendLogRow(log));
        } catch(e) { console.error("Log Load Error", e); }
    }
}

function saveLog(logData) {
    let logs = JSON.parse(localStorage.getItem("activity_logs") || "[]");
    logs.unshift(logData);
    if(logs.length > 50) logs = logs.slice(0, 50);
    localStorage.setItem("activity_logs", JSON.stringify(logs));
}

function broadcastLog(action, target) {
  const logData = {
    time: new Date().toLocaleTimeString(),
    by: myDeviceName,
    action: action,
    target: target
  };
  
  const message = new Paho.MQTT.Message(JSON.stringify(logData));
  message.destinationName = "/printer_01/logs"; 
  client.send(message);
}

function displayLog(data) {
  appendLogRow(data);
  saveLog(data);
}

function appendLogRow(data) {
    const tbody = document.getElementById("log-body");
    const row = `<tr><td>${data.time}</td><td style="color:#666; font-weight:bold;">${data.by}</td><td>${data.action}</td><td>${data.target}</td></tr>`;
    tbody.insertAdjacentHTML("afterbegin", row);
    if (tbody.rows.length > 50) tbody.deleteRow(50);
}

// ================= MQTT CONNECTION =================
function connectSystem() {
  const u = document.getElementById("mqtt-user").value;
  const p = document.getElementById("mqtt-pass").value;
  const d = document.getElementById("device-name").value || "Unknown Device";
  
  if(!u || !p) return alert("Credentials Required");

  myDeviceName = d;
  document.getElementById("display-name").innerText = myDeviceName;

  if(document.getElementById("remember-me").checked) {
    localStorage.setItem("mq_u", u);
    localStorage.setItem("mq_p", p);
    localStorage.setItem("mq_d", d);
  }

  client = new Paho.MQTT.Client("wss://" + MQTT_HOST + ":" + MQTT_PORT + "/mqtt", CLIENT_ID);
  client.onMessageArrived = onMessage;
  
  client.connect({
    useSSL: true, userName: u, password: p,
    onSuccess: () => {
      document.getElementById("login-overlay").style.display = "none";
      document.getElementById("dashboard").style.display = "block";
      
      client.subscribe("/printer_01/status");
      client.subscribe("/printer_01/logs"); 
      client.subscribe("/printer_01/sync");
      client.subscribe("/printer_01/led");
      client.subscribe("/printer_01/config/camera"); // NEW: Listen for URL updates
    },
    onFailure: (e) => alert("Connection Failed: " + e.errorMessage)
  });
}

function onMessage(m) {
  const topic = m.destinationName;
  const payload = m.payloadString;

  // HANDLE DYNAMIC CAMERA URL
  if (topic === "/printer_01/config/camera") {
      updateCameraSource(payload);
      return;
  }

  if (topic === "/printer_01/logs") {
    try { displayLog(JSON.parse(payload)); } catch(e) {}
    return;
  }

  if (topic === "/printer_01/led") {
      try {
          const d = JSON.parse(payload);
          if(d.by !== myDeviceName) {
              document.getElementById("led-slider").value = d.val;
              const percent = Math.round((d.val / 255) * 100);
              document.getElementById("led-val").innerText = percent + "%";
          }
      } catch(e) {}
      return;
  }

  if (topic === "/printer_01/sync") {
    try {
      const s = JSON.parse(payload);
      if(s.by !== myDeviceName) updateState(s.relay, s.state);
    } catch(e) {}
    return;
  }

  if (Date.now() < lockTimer) return;

  try {
    const d = JSON.parse(payload);
    if(d.relays) d.relays.forEach((s, i) => updateState(i+1, s));
    if(d.master !== undefined) updateState(9, d.master);
    if(d.v) ['v','a','w','wh'].forEach(k => {
       const el = document.getElementById(`val-${k}`);
       if(el) el.innerText = d[k];
    });
    if(d.temp) document.getElementById("val-temp").innerText = d.temp;
    if(d.humi) document.getElementById("val-humi").innerText = d.humi;
  } catch(e) { console.error(e); }
}

// ================= LOGIC & CONTROL =================
function updateState(id, state) {
  state = Number(state);
  deviceState[id] = state; 

  if (id === 9 && state === 0) {
    for (let i = 1; i <= 8; i++) {
      deviceState[i] = 0;
      const subLed = document.getElementById(`led-${i}`);
      const subBtn = document.getElementById(`btn-${i}`);
      if (subLed && subBtn) {
        subLed.classList.remove("on");
        subBtn.innerText = "TURN ON";
        subBtn.className = "btn btn-on";
      }
    }
  }

  const led = document.getElementById(`led-${id}`);
  const btn = document.getElementById(`btn-${id}`);
  if(!led || !btn) return;

  if (state === 1) {
    led.classList.add("on");
    btn.innerText = "TURN OFF";
    btn.className = "btn btn-off";
    if(id === 9) document.getElementById("panel-lock").classList.remove("disabled");
  } else {
    led.classList.remove("on");
    btn.innerText = "TURN ON";
    btn.className = "btn btn-on";
    if(id === 9) document.getElementById("panel-lock").classList.add("disabled");
  }
}

function getDeviceName(id) {
    if (id === 9) return "Main System Bus";
    if (id >= 1 && id <= 8) return LABELS[id - 1];
    return "Unknown Device";
}

function handleClick(id) {
  const currentState = deviceState[id]; 
  const newState = currentState === 1 ? 0 : 1;
  const name = getDeviceName(id);

  pendingId = id;
  pendingState = newState;

  if(newState === 1) {
    sendCommand(id, 1);
    return;
  }

  const msg = document.getElementById("confirm-msg");
  const input = document.getElementById("confirm-input");

  if(id === 9) {
    msg.innerHTML = `Type <b>CONFIRM</b> to kill <b>${name}</b>`;
    input.style.display = "block";
    input.value = "";
  } else {
    msg.innerHTML = `Turn off <b>${name}</b>?`;
    input.style.display = "none";
  }
  
  openModal("confirm-modal");
}

function executeOff() {
  if(pendingId === 9) {
    const txt = document.getElementById("confirm-input").value;
    if(txt !== "CONFIRM") return alert("Please type CONFIRM");
  }
  
  sendCommand(pendingId, pendingState);
  closeModal("confirm-modal");
}

function sendCommand(id, state) {
  lockTimer = Date.now() + 2000; 
  updateState(id, state); 
  
  const payloadObj = { relay: id, state: state, by: myDeviceName };
  const payloadStr = JSON.stringify(payloadObj);

  const msgCommand = new Paho.MQTT.Message(payloadStr);
  msgCommand.destinationName = "/printer_01/commands";
  client.send(msgCommand);

  const msgSync = new Paho.MQTT.Message(payloadStr);
  msgSync.destinationName = "/printer_01/sync"; 
  client.send(msgSync);

  broadcastLog(state ? "ON" : "OFF", getDeviceName(id));
}

function openModal(id) { document.getElementById(id).style.display = "flex"; }
function closeModal(id) { 
  if(!id) id = "confirm-modal"; 
  document.getElementById(id).style.display = "none"; 
  pendingId = null;
}
function doLogout() {
  localStorage.removeItem("mq_u");
  localStorage.removeItem("mq_p");
  location.reload();
}
setInterval(() => {
  document.getElementById("clock").innerText = new Date().toLocaleTimeString();
}, 1000);
</script>
</body>
</html>
