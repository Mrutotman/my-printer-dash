<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Mezza Control</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
  <style>
    /* --- CSS STYLES --- */
    :root { --primary: #4CAF50; --danger: #f44336; --dark: #1a1a1a; --light: #ffffff; --grey: #bbb; }
    body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f0f2f5; display: flex; flex-direction: column; height: 100vh; overflow-x: hidden; }
    
    /* Login Overlay */
    #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--dark); display: flex; align-items: center; justify-content: center; z-index: 99999; }
    .login-box { background: #2d2d2d; padding: 30px; border-radius: 12px; width: 300px; text-align: center; color: white; }
    .input-field { width: 100%; padding: 10px; margin: 5px 0; border-radius: 5px; border: 1px solid #555; background: #111; color: white; box-sizing: border-box; }
    .action-btn { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; margin-top: 10px; }
    
    /* Layout */
    .header { background: #333; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
    .container { display: flex; flex: 1; padding: 15px; gap: 15px; overflow-y: auto; flex-wrap: wrap; margin-bottom: 60px; }
    .sidebar { width: 30%; min-width: 280px; display: flex; flex-direction: column; gap: 15px; }
    .main-content { flex: 1; min-width: 300px; display: flex; flex-direction: column; gap: 15px; }
    
    .card { background: var(--light); padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    h3 { margin: 0 0 10px 0; font-size: 14px; color: #666; border-bottom: 1px solid #eee; padding-bottom: 5px; }
    
    /* Controls */
    .disabled { opacity: 0.5; pointer-events: none; filter: grayscale(100%); }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .relay-item { border: 1px solid #eee; padding: 10px; border-radius: 8px; text-align: center; background: #fafafa; }
    .led { width: 10px; height: 10px; border-radius: 50%; background: var(--grey); display: inline-block; margin-right: 5px; }
    .led.on { background: var(--primary); box-shadow: 0 0 8px var(--primary); }
    
    .btn { width: 100%; padding: 8px; margin-top: 5px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 11px; }
    .btn-on { background: #e8f5e9; color: var(--primary); border: 1px solid var(--primary); }
    .btn-off { background: #ffebee; color: var(--danger); border: 1px solid var(--danger); }

    /* --- CAMERA BOX --- */
    .camera-box { 
        background: black; 
        width: 100%; 
        aspect-ratio: 16/9; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        color: #555; 
        border-radius: 8px; 
        position: relative; 
        overflow: hidden; 
    }

    img#cam-stream {
        width: 100%;
        height: 100%;
        object-fit: contain; 
        transform: rotate(180deg);
        display: none; 
    }

    .pzem-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; text-align: center; }
    .pzem-val { font-size: 18px; font-weight: bold; }
    .pzem-label { font-size: 10px; color: #888; }
    
    .log-list { font-size: 11px; height: 150px; overflow-y: auto; border-top: 1px solid #eee; }
    .log-table { width: 100%; border-collapse: collapse; }
    .log-table th { text-align: left; background: #f9f9f9; padding: 5px; position: sticky; top: 0; }
    .log-table td { padding: 5px; border-bottom: 1px solid #eee; color: #555; }

    /* Modals */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; align-items: center; justify-content: center; }
    
    .modal-box { 
        background: white; 
        padding: 25px; 
        border-radius: 10px; 
        width: 300px; 
        text-align: center; 
        max-height: 80vh; 
        overflow-y: auto; 
    }
    .modal-wide { width: 90%; max-width: 600px; text-align: left; }

    /* Tutorial Styles */
    .tut-header { border-bottom: 2px solid var(--primary); padding-bottom: 10px; margin-bottom: 15px; color: #333; display: flex; justify-content: space-between; align-items: center;}
    .tut-section { flex: 1; margin-bottom: 0; min-height: auto;}
    .tut-step { background: #f9f9f9; padding: 10px; border-left: 4px solid var(--primary); margin-bottom: 10px; border-radius: 0 5px 5px 0; font-size: 13px; color: #444; }
    .code-block { background: #333; color: #0f0; padding: 8px; border-radius: 5px; font-family: 'Courier New', monospace; font-size: 11px; display: block; margin: 5px 0; overflow-x: auto; white-space: nowrap; }
    .tut-warn { color: #d32f2f; font-weight: bold; font-size: 12px; background: #ffebee; padding: 5px; border-radius: 4px; }
    
    /* Tutorial Navigation */
    .tut-nav { display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #eee; padding-top: 15px; }
    .tut-btn { padding: 8px 15px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; background: #eee; color: #555; }
    .tut-btn:hover { background: #ddd; }
    .tut-btn.primary { background: var(--primary); color: white; }
    
    /* Tutorial Image */
    .tut-img { 
        width: 250px;               /* Fixed width for the image column */
        flex-shrink: 0;             /* Prevent image from being squished */
        height: auto;               /* Maintain aspect ratio */
        object-fit: contain;        /* Ensure image fits nicely */
        border-radius: 8px; 
        border: 1px solid #ddd;
    }
    .tut-content-scroll {
        display: flex;              /* Enables side-by-side layout */
        flex-direction: row;        /* Row orientation */
        gap: 20px;                  /* Space between image and text */
        max-height: 500px;          /* Increased height slightly */
        overflow-y: auto;           /* Scrollbar if content is very long */
        padding-right: 10px;
        align-items: flex-start;    /* Align items to the top */
    }
    /* Config Buttons */
    #config-btn { position: fixed; bottom: 140px; left: 20px; width: 45px; height: 45px; border-radius: 50%; background: #555; color: white; font-weight: bold; font-size: 20px; border: 1px solid #777; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.4); z-index: 99999; }
    #help-btn { position: fixed; bottom: 80px; left: 20px; width: 45px; height: 45px; border-radius: 50%; background: #333; color: white; font-weight: bold; font-size: 20px; border: 1px solid #555; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.4); z-index: 99999; transition: 0.3s; }
    #help-btn:active { transform: scale(0.9); }

    footer { position: fixed; bottom: 0; width: 100%; background: #333; color: white; padding: 15px 0; display: flex; justify-content: space-around; font-size: 12px; }

    @media (max-width: 700px) {
      .tut-content-scroll {
         flex-direction: column; /* Stack them back up */
      }
      .tut-img {
         width: 100%; /* Full width image on mobile */
         max-width: none;
         margin-bottom: 15px;
      }
    }

  </style>
</head>
<body>

  <div id="login-overlay">
    <div class="login-box">
      <h2>SYSTEM LOGIN</h2>
      <input type="text" id="mqtt-user" class="input-field" placeholder="HiveMQ Username">
      <input type="password" id="mqtt-pass" class="input-field" placeholder="HiveMQ Password">
      <hr style="border: 0; border-top: 1px solid #444; margin: 15px 0;">
      <input type="text" id="device-name" class="input-field" placeholder="Device Name (e.g. Red's Phone)">
      <div style="font-size:12px; text-align:left; margin-top:5px;">
        <input type="checkbox" id="remember-me"> Remember Me
      </div>
      <button class="action-btn" onclick="connectSystem()">CONNECT</button>
    </div>
  </div>

  <div id="dashboard" style="display:none;">
    <header class="header">
      <strong>SMART MEZZA CONTROL</strong>
      <div style="font-size:11px;">
        <span id="display-name" style="color:#aaa; margin-right:10px;">Unknown Device</span>
        <button onclick="doLogout()" style="background:none; border:1px solid #666; color:#ccc; padding:5px 10px; cursor:pointer;">EXIT</button>
      </div>
    </header>

    <div class="container">
      <div class="sidebar">
        <div class="card">
          <h3>MASTER POWER (ID: 9)</h3>
          <div style="text-align:center; margin-bottom:10px;">
            <span id="led-9" class="led"></span> <b>System Bus</b>
          </div>
          <button id="btn-9" class="btn btn-on" onclick="handleClick(9)">TURN ON</button>
        </div>

        <div id="panel-lock" class="card disabled">
          <h3>CONTROL PANEL</h3>
          <div class="grid-2" id="relay-grid"></div>
        </div>
      </div>

      <div class="main-content">
        <div class="card">
          <h3>LIVE FEED (Auto-Synced)</h3>
           
          <div class="camera-box">
            <img id="cam-stream" src="" alt="Live Feed" onload="this.style.display='block'; document.getElementById('cam-msg').style.display='none';">
            
            <div id="cam-msg" style="position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; color:#555; z-index:5;">
                <span id="cam-status-text" style="font-size:16px; font-weight:bold;">WAITING FOR LINK...</span>
                <span style="font-size:10px;">Click ⚙️ to set Cloudflare Link</span>
            </div>
          </div>
        </div>

        <div class="card">
          <h3>POWER MONITOR</h3>
          <div class="pzem-grid">
            <div><div id="val-v" class="pzem-val">0</div><div class="pzem-label">VOLTS</div></div>
            <div><div id="val-a" class="pzem-val">0.00</div><div class="pzem-label">AMPS</div></div>
            <div><div id="val-w" class="pzem-val">0</div><div class="pzem-label">WATTS</div></div>
            <div><div id="val-wh" class="pzem-val">0.00</div><div class="pzem-label">Wh</div></div>
          </div>
        </div>

        <div class="card" style="flex:1;">
          <h3>ACTIVITY LOG</h3>
          <div class="log-list">
            <table class="log-table">
              <thead>
                <tr><th>Time</th><th>By</th><th>Action</th><th>Target</th></tr>
              </thead>
              <tbody id="log-body"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <button id="config-btn" onclick="openModal('config-modal')">⚙️</button>
    <button id="help-btn" onclick="openModal('tutorial-modal')">?</button>

    <footer>
      <span id="clock">--:--:--</span>
      <span>Temp: <b id="val-temp">--</b>°C</span>
      <span>Humi: <b id="val-humi">--</b>%</span>
    </footer>
  </div>
  
<div id="config-modal" class="modal-overlay">
  <div class="modal-box">
    <h3>⚙️ SYSTEM CONFIG</h3>
    <p style="font-size: 12px; color: #666;">Enter the Cloudflare Tunnel URL for the ESP32-CAM stream.</p>
    <input type="text" id="stream-input" class="input-field" placeholder="https://your-tunnel.trycloudflare.com" style="color: black; background: #eee;">
    <div style="display: flex; gap: 10px; margin-top: 15px;">
      <button class="action-btn" onclick="saveConfig()">SAVE LINK</button>
      <button class="action-btn" style="background: #555;" onclick="closeModal('config-modal')">CANCEL</button>
    </div>
  </div>
</div>
  
<div id="tutorial-modal" class="modal-overlay">
  <div class="modal-box modal-wide">
    <div class="tut-header">
       <span id="tut-title-text">MANUAL</span>
       <span id="tut-page-indicator" style="font-size:10px; background:#eee; padding:2px 6px; border-radius:4px;">1/5</span>
    </div>
    
    <div class="tut-content-scroll">
      <img id="tut-image-display" src="" class="tut-img" style="display:none;">
      <div id="tut-content-area" class="tut-section"></div>
    </div>

    <div class="tut-nav">
       <button class="tut-btn" id="btn-prev" onclick="changeTutorialPage(-1)">Previous</button>
       <button class="tut-btn" onclick="closeModal('tutorial-modal')">Close</button>
       <button class="tut-btn primary" id="btn-next" onclick="changeTutorialPage(1)">Next</button>
    </div>
  </div>
</div>

  <div id="tutorial-modal" class="modal-overlay">
    <div class="modal-box modal-wide">
      <div class="tut-header">
         <span id="tut-title-text">MANUAL</span>
         <span id="tut-page-indicator" style="font-size:10px; background:#eee; padding:2px 6px; border-radius:4px;">1/5</span>
      </div>
      
      <div class="tut-content-scroll">
        <img id="tut-image-display" src="" class="tut-img" style="display:none;">
        <div id="tut-content-area" class="tut-section"></div>
      </div>
  
      <div class="tut-nav">
         <button class="tut-btn" id="btn-prev" onclick="changeTutorialPage(-1)">Previous</button>
         <button class="tut-btn" onclick="closeModal('tutorial-modal')">Close</button>
         <button class="tut-btn primary" id="btn-next" onclick="changeTutorialPage(1)">Next</button>
      </div>
    </div>
  </div>

  <div id="confirm-modal" class="modal-overlay">
    <div class="modal-box">
      <h3 style="color:var(--danger)">⚠️ CONFIRM ACTION</h3>
      <p id="confirm-msg">Type CONFIRM to turn off.</p>
      <input type="text" id="confirm-input" class="input-field" style="text-align:center; color:black; background:#eee;" placeholder="Type CONFIRM">
      <div style="display:flex; gap:10px; margin-top:15px;">
        <button class="btn btn-off" onclick="executeOff()">CONFIRM OFF</button>
        <button class="btn btn-on" style="background:#ddd; color:#333; border:1px solid #ccc;" onclick="closeModal('confirm-modal')">CANCEL</button>
      </div>
    </div>
  </div>

<script>
// ================= CONFIGURATION =================
const MQTT_HOST = "143fa294384e4a2fa42c7bfe8a7ebd1d.s1.eu.hivemq.cloud";
const MQTT_PORT = 8884;
const CLIENT_ID = "web_" + Math.random().toString(16).substr(2, 8);
const LABELS = ["Printer 1", "Printer 2", "Printer 3", "Printer 4", "LED", "Free 1", "Free 2", "Free 3"];

let client = null;
let currentCameraUrl = "";
let myDeviceName = "Unknown";
let deviceState = { 1:0, 2:0, 3:0, 4:0, 5:0, 6:0, 7:0, 8:0, 9:0 }; 
let pendingId = null; 
let pendingState = null;
let lockTimer = 0; 
let currentTutPage = 0;

// ================= INITIALIZATION =================
window.onload = () => {
  renderRelays();
  loadStoredLogs(); 

  const u = localStorage.getItem("mq_u");
  const p = localStorage.getItem("mq_p");
  const d = localStorage.getItem("mq_d"); 
  
  if(u && p) { 
    document.getElementById("mqtt-user").value = u;
    document.getElementById("mqtt-pass").value = p;
    if(d) document.getElementById("device-name").value = d;
    connectSystem();
  }
};

// ================= TUTORIAL DATA & LOGIC =================
const tutorialData = [
        {
          title: "1. MAIN HOST: ESP32",
          img: "https://via.placeholder.com/600x300/2d2d2d/ffffff?text=ESP32+Pinout+&+Relay+Logic",
          content: `
              <p>The brain of the Smart Mezza is an <b>ESP32 DevKit V1</b>. It manages the relay logic, sensor data, and MQTT communication.</p>
              <div class="tut-step">
                  <b>Relay Control:</b> GPIO pins drive the 8-channel relay module. Note that most relay modules are <i>Active-Low</i>, meaning the ESP32 pulls the pin to GND to turn the printer ON.
              </div>
              <div class="tut-step">
                  <b>Power Supply:</b> The ESP32 is powered via 5V DC. Ensure the ground (GND) is common between the ESP32 and the relay board to prevent switching noise.
              </div>
              <div class="tut-warn">⚠️ VOLTAGE: Never connect the AC mains directly to the ESP32 pins. Use the relay isolation.</div>
          `
      },
  
      {
        title: "2. LIVE FEED: ESP32-CAM",
        img: "https://via.placeholder.com/600x300/1a1a1a/ffffff?text=ESP32-CAM+Wiring+&+Power",
        content: `
            <p>A separate <b>ESP32-CAM</b> module provides the live video stream of the 3D printer bed.</p>
            <div class="tut-step">
                <b>Stream Logic:</b> The camera runs a local web server on port 80. The <i>Cloudflared</i> tunnel on your PC captures this local IP and broadcasts it to the dashboard link.
            </div>
            <div class="tut-step">
                <b>Power Requirement:</b> The ESP32-CAM is sensitive to power drops. It is recommended to use a dedicated 5V power source capable of at least 2A to prevent "Brownout" resets during streaming.
            </div>
            <div class="tut-step">
                <b>Orientation:</b> In this dashboard, the CSS is set to <i>transform: rotate(180deg)</i>. Mount the camera accordingly or adjust the CSS if your view is upside down.
            </div>
          `
    },
  
    {
        title: "3. SYSTEM ARCHITECTURE",
        // Replace with your actual image path (e.g., "img/layout.png")
        img: "https://via.placeholder.com/600x300/4CAF50/ffffff?text=Dashboard+Layout+Overview", 
        content: `
            <p>Welcome to the <b>Smart Mezza Control System</b>. This interface communicates via MQTT to your ESP32 controller at the PUP EE Laboratory.</p>
            <div class="tut-step">
                <b>Master Power (System Bus):</b> This is the gatekeeper. When OFF, it physically disconnects the relay bank. No device that is connected to relay can be toggled unless this is ON.
            </div>
            <div class="tut-step">
                <b>Real-Time Sync:</b> If another user (e.g., on a different phone) toggles a switch, your dashboard updates automatically within 200ms.
            </div>
        `
    },
    {
        title: "4. SAFETY & SHUTDOWN",
        img: "https://via.placeholder.com/600x300/f44336/ffffff?text=Two-Step+Shutdown+Logic",
        content: `
            <p>To prevent accidental print failures, we have implemented a <b>Two-Step Safety Protocol</b>.</p>
            <div class="tut-step">
                <b>The "CONFIRM" Requirement:</b> Turning OFF the Master Power or individual printers requires an explicit confirmation. For the Master Power, you must type "CONFIRM" in all caps.
            </div>
            <div class="tut-warn">⚠️ WARNING: Killing the Master Power during an active print will cause the hotend to stop cooling immediately, which may cause heat creep/clogging.</div>
        `
    },
    {
        title: "5. CLOUD CAMERA SETUP",
        img: "https://via.placeholder.com/600x300/333333/ffffff?text=Cloudflare+Tunnel+Guide",
        content: `
            <p>The live feed uses a secure Cloudflare Tunnel to bypass local firewall restrictions.</p>
            <div class="tut-step">
                <b>Step 1:</b> Run the tunnel on your local PC: <br>
                <code class="code-block">cloudflared tunnel --url http://[ESP32_IP]:80</code>
            </div>
            <div class="tut-step">
                <b>Step 2:</b> Copy the <i>.trycloudflare.com</i> link and click the ⚙️ icon on the dashboard to save it. This link is stored in the HiveMQ broker so all users see the same stream.
            </div>
        `
    },
    {
        title: "6. POWER MONITORING",
        img: "https://via.placeholder.com/600x300/2196F3/ffffff?text=PZEM-004T+Data+Reading",
        content: `
            <p>The <b>PZEM-004T</b> module tracks high-voltage metrics from the printer bus.</p>
            <ul>
                <li><b>Voltage:</b> Ensure it stays between 210V-230V.</li>
                <li><b>Current (Amps):</b> Monitor this when multiple printers start heating up.</li>
                <li><b>Wattage:</b> Helpful for calculating the cost-per-print.</li>
            </ul>
        `
    },
    {
        title: "7. ACTIVITY AUDITING",
        img: "https://via.placeholder.com/600x300/777777/ffffff?text=Security+Activity+Logs",
        content: `
            <p>Security is maintained through the <b>Activity Log</b>.</p>
            <div class="tut-step">
                Every action is tagged with your <b>Device Name</b>. This ensures accountability for who turned off a specific printer. Logs are ephemeral and reset when the page is hard-refreshed, but the last 50 actions are stored in your local browser history.
            </div>
        `
    }
];

function renderTutorial() {
    const data = tutorialData[currentTutPage];
    const imgEl = document.getElementById("tut-image-display");
    
    document.getElementById("tut-title-text").innerText = data.title;
    document.getElementById("tut-content-area").innerHTML = data.content;
    document.getElementById("tut-page-indicator").innerText = `${currentTutPage + 1}/${tutorialData.length}`;

    // Handle Image Visibility
    if (data.img) {
        imgEl.src = data.img;
        imgEl.style.display = "block";
    } else {
        imgEl.style.display = "none";
    }

    const prevBtn = document.getElementById("btn-prev");
    const nextBtn = document.getElementById("btn-next");
    prevBtn.disabled = (currentTutPage === 0);
    prevBtn.style.opacity = (currentTutPage === 0) ? "0.3" : "1";
    nextBtn.innerText = (currentTutPage === tutorialData.length - 1) ? "Finish" : "Next";
}

function changeTutorialPage(dir) {
    if (dir === 1 && currentTutPage === tutorialData.length - 1) {
        closeModal('tutorial-modal');
        return;
    }
    currentTutPage += dir;
    if (currentTutPage < 0) currentTutPage = 0;
    if (currentTutPage >= tutorialData.length) currentTutPage = tutorialData.length - 1;
    renderTutorial();
}

// ================= DYNAMIC CAMERA SYSTEM =================
function saveConfig() {
    let newUrl = document.getElementById("stream-input").value.trim();
    if(newUrl.endsWith("/")) newUrl = newUrl.slice(0, -1);
    
    // Ensure we have /stream for the video
    if(!newUrl.includes("/stream")) newUrl += "/stream";

    if(!newUrl.startsWith("https://")) {
        alert("Link must start with https://");
        return;
    }

    if(client && client.isConnected()) {
        const msg = new Paho.MQTT.Message(newUrl);
        msg.destinationName = "/printer_01/config/camera";
        msg.retained = true; 
        client.send(msg);
        alert("Link Saved & Synced!");
        closeModal('config-modal');
    } else {
        alert("Not connected to System. Login first.");
    }
}

function updateCameraSource(url) {
    if(!url || url === currentCameraUrl) return;
    currentCameraUrl = url;
    const cam = document.getElementById("cam-stream");
    cam.src = url; 
}

function renderRelays() {
  const container = document.getElementById("relay-grid");
  container.innerHTML = "";
  LABELS.forEach((name, index) => {
    const id = index + 1;
    container.innerHTML += `
      <div class="relay-item">
        <div><span id="led-${id}" class="led"></span> <b>${name}</b></div>
        <button id="btn-${id}" class="btn btn-on" onclick="handleClick(${id})">TURN ON</button>
      </div>`;
  });
}

// ================= LOG SYSTEM =================
function loadStoredLogs() {
    const stored = localStorage.getItem("activity_logs");
    if(stored) {
        try {
            const logs = JSON.parse(stored);
            logs.forEach(log => appendLogRow(log));
        } catch(e) {}
    }
}

function saveLog(logData) {
    let logs = JSON.parse(localStorage.getItem("activity_logs") || "[]");
    logs.unshift(logData);
    if(logs.length > 50) logs = logs.slice(0, 50);
    localStorage.setItem("activity_logs", JSON.stringify(logs));
}

function broadcastLog(action, target) {
  const logData = { time: new Date().toLocaleTimeString(), by: myDeviceName, action: action, target: target };
  const message = new Paho.MQTT.Message(JSON.stringify(logData));
  message.destinationName = "/printer_01/logs"; 
  client.send(message);
}

function displayLog(data) {
  appendLogRow(data);
  saveLog(data);
}

function appendLogRow(data) {
    const tbody = document.getElementById("log-body");
    const row = `<tr><td>${data.time}</td><td style="color:#666; font-weight:bold;">${data.by}</td><td>${data.action}</td><td>${data.target}</td></tr>`;
    tbody.insertAdjacentHTML("afterbegin", row);
    if (tbody.rows.length > 50) tbody.deleteRow(50);
}

// ================= MQTT CONNECTION =================
function connectSystem() {
  const u = document.getElementById("mqtt-user").value;
  const p = document.getElementById("mqtt-pass").value;
  const d = document.getElementById("device-name").value || "Unknown Device";
  
  if(!u || !p) return alert("Credentials Required");

  myDeviceName = d;
  document.getElementById("display-name").innerText = myDeviceName;

  if(document.getElementById("remember-me").checked) {
    localStorage.setItem("mq_u", u);
    localStorage.setItem("mq_p", p);
    localStorage.setItem("mq_d", d);
  }

  client = new Paho.MQTT.Client("wss://" + MQTT_HOST + ":" + MQTT_PORT + "/mqtt", CLIENT_ID);
  client.onMessageArrived = onMessage;
  
  client.connect({
    useSSL: true, userName: u, password: p,
    onSuccess: () => {
      document.getElementById("login-overlay").style.display = "none";
      document.getElementById("dashboard").style.display = "block";
      
      client.subscribe("/printer_01/status");
      client.subscribe("/printer_01/logs"); 
      client.subscribe("/printer_01/sync");
      client.subscribe("/printer_01/config/camera");
    },
    onFailure: (e) => alert("Connection Failed: " + e.errorMessage)
  });
}

function onMessage(m) {
  const topic = m.destinationName;
  const payload = m.payloadString;

  if (topic === "/printer_01/config/camera") {
      updateCameraSource(payload);
      return;
  }
  if (topic === "/printer_01/logs") {
    try { displayLog(JSON.parse(payload)); } catch(e) {}
    return;
  }
  if (topic === "/printer_01/sync") {
    try {
      const s = JSON.parse(payload);
      if(s.by !== myDeviceName) updateState(s.relay, s.state);
    } catch(e) {}
    return;
  }

  if (Date.now() < lockTimer) return;

  try {
    const d = JSON.parse(payload);
    if(d.relays) d.relays.forEach((s, i) => updateState(i+1, s));
    if(d.master !== undefined) updateState(9, d.master);
    if(d.v) ['v','a','w','wh'].forEach(k => {
       const el = document.getElementById(`val-${k}`);
       if(el) el.innerText = d[k];
    });
    if(d.temp) document.getElementById("val-temp").innerText = d.temp;
    if(d.humi) document.getElementById("val-humi").innerText = d.humi;
  } catch(e) { console.error(e); }
}

// ================= LOGIC & CONTROL =================
function updateState(id, state) {
  state = Number(state);
  deviceState[id] = state; 

  if (id === 9 && state === 0) {
    for (let i = 1; i <= 8; i++) {
      deviceState[i] = 0;
      const subLed = document.getElementById(`led-${i}`);
      const subBtn = document.getElementById(`btn-${i}`);
      if (subLed && subBtn) {
        subLed.classList.remove("on");
        subBtn.innerText = "TURN ON";
        subBtn.className = "btn btn-on";
      }
    }
  }

  const led = document.getElementById(`led-${id}`);
  const btn = document.getElementById(`btn-${id}`);
  if(!led || !btn) return;

  if (state === 1) {
    led.classList.add("on");
    btn.innerText = "TURN OFF";
    btn.className = "btn btn-off";
    if(id === 9) document.getElementById("panel-lock").classList.remove("disabled");
  } else {
    led.classList.remove("on");
    btn.innerText = "TURN ON";
    btn.className = "btn btn-on";
    if(id === 9) document.getElementById("panel-lock").classList.add("disabled");
  }
}

function getDeviceName(id) {
    if (id === 9) return "Main System Bus";
    if (id >= 1 && id <= 8) return LABELS[id - 1];
    return "Unknown Device";
}

function handleClick(id) {
  const currentState = deviceState[id]; 
  const newState = currentState === 1 ? 0 : 1;
  const name = getDeviceName(id);

  pendingId = id;
  pendingState = newState;

  if(newState === 1) {
    sendCommand(id, 1);
    return;
  }

  const msg = document.getElementById("confirm-msg");
  const input = document.getElementById("confirm-input");

  if(id === 9) {
    msg.innerHTML = `Type <b>CONFIRM</b> to kill <b>${name}</b>`;
    input.style.display = "block";
    input.value = "";
  } else {
    msg.innerHTML = `Turn off <b>${name}</b>?`;
    input.style.display = "none";
  }
  
  openModal("confirm-modal");
}

function executeOff() {
  if(pendingId === 9) {
    const txt = document.getElementById("confirm-input").value;
    if(txt !== "CONFIRM") return alert("Please type CONFIRM");
  }
  
  sendCommand(pendingId, pendingState);
  closeModal("confirm-modal");
}

function sendCommand(id, state) {
  lockTimer = Date.now() + 2000; 
  updateState(id, state); 
  
  const payloadObj = { relay: id, state: state, by: myDeviceName };
  const payloadStr = JSON.stringify(payloadObj);

  const msgCommand = new Paho.MQTT.Message(payloadStr);
  msgCommand.destinationName = "/printer_01/commands";
  client.send(msgCommand);

  const msgSync = new Paho.MQTT.Message(payloadStr);
  msgSync.destinationName = "/printer_01/sync"; 
  client.send(msgSync);

  broadcastLog(state ? "ON" : "OFF", getDeviceName(id));
}

function openModal(id) { 
    if(id === 'tutorial-modal') {
        currentTutPage = 0;
        renderTutorial();
    }
    document.getElementById(id).style.display = "flex"; 
}

function closeModal(id) { 
  if(!id) id = "confirm-modal"; 
  document.getElementById(id).style.display = "none"; 
  pendingId = null;
}
function doLogout() {
  localStorage.removeItem("mq_u");
  localStorage.removeItem("mq_p");
  location.reload();
}
setInterval(() => {
  document.getElementById("clock").innerText = new Date().toLocaleTimeString();
}, 1000);
</script>
</body>
</html>
