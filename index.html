<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Smart 3D Printer Dash - GLOBAL</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', Arial; margin: 0; background-color: #f4f4f9; display: flex; flex-direction: column; height: 100vh; }
    
    /* Loading Screen Styling */
    #loading-screen {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: #333;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      z-index: 9999;
      color: white;
      transition: opacity 0.5s ease;
    }
    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top: 4px solid #4CAF50;
      width: 40px; height: 40px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* Original Styling */
    header { background: #333; color: white; padding: 10px 20px; text-align: left; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    .main-container { display: flex; flex: 1; overflow: hidden; padding: 15px; gap: 20px; }
    .sidebar { width: 40%; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
    .monitoring { width: 60%; display: flex; flex-direction: column; gap: 15px; }
    .section { background: white; border-radius: 12px; padding: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .relay-card { border: 1px solid #eee; padding: 10px; border-radius: 8px; background: #fafafa; text-align: center; }
    .btn { font-size: 13px; padding: 10px; margin-top: 8px; border: none; border-radius: 6px; cursor: pointer; width: 100%; font-weight: bold; transition: 0.3s; }
    .on { background-color: #4CAF50; color: white; }
    .off { background-color: #f44336; color: white; }
    .master-btn { font-size: 16px; padding: 15px; }
    .status-text { font-weight: bold; font-size: 14px; }
    .green { color: #2e7d32; }
    .red { color: #c62828; }
    .placeholder { border: 2px dashed #ccc; color: #999; display: flex; align-items: center; justify-content: center; min-height: 250px; font-style: italic; background: #ebebef; }
    #help-btn { position: fixed; bottom: 20px; left: 20px; width: 40px; height: 40px; border-radius: 50%; background: #333; color: white; font-weight: bold; font-size: 20px; border: none; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.3); z-index: 1000; }
    .modal { display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; }
    .modal-content { background: white; padding: 25px; border-radius: 12px; max-width: 400px; text-align: center; }
    .modal-btns { display: flex; gap: 10px; justify-content: center; margin-top: 20px; }
    #cloud-bar { background: #222; color: #00ff00; font-size: 11px; padding: 3px 20px; text-align: right; }
  </style>
</head>
<body>

  <div id="loading-screen">
    <div class="spinner"></div>
    <div id="loading-text">Connecting to Printer Farm Cloud...</div>
  </div>

  <div id="cloud-bar">SYNCING...</div>
  <header><h2>SMART 3D PRINTER DASHBOARD (GLOBAL)</h2></header>

  <div class="main-container">
    <div class="sidebar">
      <div class="section">
        <h3>MASTER POWER</h3>
        <p>Status: <span id="relay9_status" class="status-text red">OFF</span></p>
        <button id="relay9_btn" class="btn master-btn on" onclick="handleRelayAction(9)">TURN MASTER ON</button>
      </div>
      <div class="section">
        <h3>CONTROL PANEL</h3>
        <div class="grid" id="relay-container"></div>
      </div>
    </div>

    <div class="monitoring">
      <div class="section"><h3>CAMERA FEED</h3><div class="placeholder">Stream Output...</div></div>
      <div class="section"><h3>ENERGY MONITORING</h3><div class="placeholder">Power Statistics...</div></div>
    </div>
  </div>

  <button id="help-btn" onclick="toggleModal('tutorial-modal')">?</button>

  <div id="warning-modal" class="modal">
    <div class="modal-content">
      <h3 style="color:#c62828">⚠️ WARNING</h3>
      <p id="warning-text">Confirm Action?</p>
      <div class="modal-btns">
        <button class="btn on" style="width: 80px;" onclick="confirmAction()">YES</button>
        <button class="btn off" style="width: 80px;" onclick="closeModals()">NO</button>
      </div>
    </div>
  </div>

  <div id="tutorial-modal" class="modal">
    <div class="modal-content" style="text-align: left;">
      <h3 style="text-align:center">Tutorial & Help</h3>
      <p><b>1. Master Power:</b> Must be ON before individual printers start.</p>
      <p><b>2. Global Dash:</b> Access your farm from any network.</p>
      <p><b>3. Safety:</b> Confirmations are required for SHUTDOWN commands.</p>
      <button class="btn on" onclick="closeModals()">GOT IT</button>
    </div>
  </div>

<script>
let pendingId = null;

// MQTT Setup
const MQTT_HOST = "143fa294384e4a2fa42c7bfe8a7ebd1d.s1.eu.hivemq.cloud";
const MQTT_PORT = 8884; 
const MQTT_USER = "hivemq.webclient.1769879772484";
const MQTT_PASS = "e9GHjk0b18hiCBAD%<$!";
const CLIENT_ID = "web_ui_" + Math.random().toString(16).substr(2, 8);

const client = new Paho.MQTT.Client("wss://" + MQTT_HOST + ":" + MQTT_PORT + "/mqtt", CLIENT_ID);

client.onMessageArrived = (message) => {
  try {
    const data = JSON.parse(message.payloadString);
    if(data.relays) data.relays.forEach((state, index) => updateUI(index + 1, state));
    if(data.hasOwnProperty('master')) updateUI(9, data.master);
    
    // Hide loading screen once first data arrives
    hideLoading();
  } catch(e) { console.error(e); }
};

client.connect({
  useSSL: true, userName: MQTT_USER, password: MQTT_PASS,
  onSuccess: () => {
    document.getElementById('cloud-bar').innerText = "GLOBAL CLOUD: CONNECTED";
    client.subscribe("/printer_01/status");
    // Fallback: hide loading after 2s if no message arrives but connection is up
    setTimeout(hideLoading, 2000);
  },
  onFailure: () => {
    document.getElementById('loading-text').innerText = "Connection Failed. Refreshing...";
    setTimeout(() => location.reload(), 3000);
  }
});

function hideLoading() {
  const loader = document.getElementById('loading-screen');
  loader.style.opacity = '0';
  setTimeout(() => loader.style.display = 'none', 500);
}

// Generate UI
const container = document.getElementById('relay-container');
const labels = ["Printer 1", "Printer 2", "Printer 3", "Printer 4", "Free 1", "Free 2", "LED Light", "Spare"];
for (let i = 1; i <= 8; i++) {
  container.innerHTML += `
    <div class="relay-card">
      <small style="color: #666;">${labels[i-1]}</small><br>
      <span id="relay${i}_status" class="status-text red">OFF</span><br>
      <button id="relay${i}_btn" class="btn on" onclick="handleRelayAction(${i})">ON</button>
    </div>`;
}

function handleRelayAction(id) {
  const statusEl = document.getElementById(`relay${id}_status`);
  const isCurrentlyOn = statusEl.innerText.includes("ON");
  if (isCurrentlyOn) {
    pendingId = id;
    document.getElementById('warning-text').innerText = (id === 9) ? "Turning off Master will kill ALL printers. Continue?" : "Are you sure you want to turn off " + labels[id-1] + "?";
    toggleModal('warning-modal');
  } else {
    sendMqttCmd(id, 1);
  }
}

function confirmAction() {
  if (pendingId !== null) sendMqttCmd(pendingId, 0);
  closeModals();
}

function sendMqttCmd(id, state) {
  const msg = new Paho.MQTT.Message(JSON.stringify({relay: id, state: state}));
  msg.destinationName = "/printer_01/commands";
  client.send(msg);
  pendingId = null;
}

function updateUI(id, state) {
  const statusEl = document.getElementById(`relay${id}_status`);
  const btnEl = document.getElementById(`relay${id}_btn`);
  if(!statusEl || !btnEl) return;
  
  if (state == 1) {
    statusEl.innerHTML = "ON"; statusEl.className = "status-text green";
    btnEl.innerHTML = (id === 9) ? "TURN MASTER OFF" : "TURN OFF";
    btnEl.className = (id === 9) ? "btn master-btn off" : "btn off";
  } else {
    statusEl.innerHTML = "OFF"; statusEl.className = "status-text red";
    btnEl.innerHTML = (id === 9) ? "TURN MASTER ON" : "TURN ON";
    btnEl.className = (id === 9) ? "btn master-btn on" : "btn on";
  }
}

function toggleModal(id) { document.getElementById(id).style.display = 'flex'; }
function closeModals() { 
  document.getElementById('warning-modal').style.display = 'none'; 
  document.getElementById('tutorial-modal').style.display = 'none'; 
}
</script>
</body>
</html>
