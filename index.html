<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Mezza 3D Printer Control</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
  <style>
    /* --- CSS STYLES --- */
    :root { --primary: #4CAF50; --danger: #f44336; --dark: #1a1a1a; --light: #ffffff; --grey: #bbb; }
    body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f0f2f5; display: flex; flex-direction: column; height: 100vh; overflow-x: hidden; }
    
    /* Login Overlay */
    #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--dark); display: flex; align-items: center; justify-content: center; z-index: 99999; }
    .login-box { background: #2d2d2d; padding: 30px; border-radius: 12px; width: 300px; text-align: center; color: white; }
    .input-field { width: 100%; padding: 10px; margin: 5px 0; border-radius: 5px; border: 1px solid #555; background: #111; color: white; box-sizing: border-box; }
    .action-btn { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; margin-top: 10px; }
    
    /* Layout */
    .header { background: #333; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
    .container { display: flex; flex: 1; padding: 15px; gap: 15px; overflow-y: auto; flex-wrap: wrap; margin-bottom: 60px; }
    .sidebar { width: 30%; min-width: 280px; display: flex; flex-direction: column; gap: 15px; }
    .main-content { flex: 1; min-width: 300px; display: flex; flex-direction: column; gap: 15px; }
    
    .card { background: var(--light); padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    h3 { margin: 0 0 10px 0; font-size: 14px; color: #666; border-bottom: 1px solid #eee; padding-bottom: 5px; }
    
    /* Controls */
    .disabled { opacity: 0.5; pointer-events: none; filter: grayscale(100%); }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .relay-item { border: 1px solid #eee; padding: 10px; border-radius: 8px; text-align: center; background: #fafafa; }
    .led { width: 10px; height: 10px; border-radius: 50%; background: var(--grey); display: inline-block; margin-right: 5px; }
    .led.on { background: var(--primary); box-shadow: 0 0 8px var(--primary); }
    
    .btn { width: 100%; padding: 8px; margin-top: 5px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 11px; }
    .btn-on { background: #e8f5e9; color: var(--primary); border: 1px solid var(--primary); }
    .btn-off { background: #ffebee; color: var(--danger); border: 1px solid var(--danger); }

    /* Monitoring */
    .camera-box { background: black; width: 100%; aspect-ratio: 16/9; max-height: 350px; display: flex; align-items: center; justify-content: center; color: #555; border-radius: 8px; }
    
    .pzem-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; text-align: center; }
    .pzem-val { font-size: 18px; font-weight: bold; }
    .pzem-label { font-size: 10px; color: #888; }
    
    /* LOG TABLE */
    .log-list { font-size: 11px; height: 150px; overflow-y: auto; border-top: 1px solid #eee; }
    .log-table { width: 100%; border-collapse: collapse; }
    .log-table th { text-align: left; background: #f9f9f9; padding: 5px; position: sticky; top: 0; }
    .log-table td { padding: 5px; border-bottom: 1px solid #eee; color: #555; }

    /* Modals */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; align-items: center; justify-content: center; }
    .modal-box { background: white; padding: 25px; border-radius: 10px; width: 300px; text-align: center; }
    
    #help-btn { position: fixed; bottom: 80px; left: 20px; width: 45px; height: 45px; border-radius: 50%; background: #333; color: white; font-weight: bold; font-size: 20px; border: 1px solid #555; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.4); z-index: 99999; transition: 0.3s; }
    #help-btn:active { transform: scale(0.9); }

    footer { position: fixed; bottom: 0; width: 100%; background: #333; color: white; padding: 15px 0; display: flex; justify-content: space-around; font-size: 12px; }

    @media (max-width: 700px) {
      .container { flex-direction: column; }
      .sidebar, .main-content { width: 100%; }
      #help-btn { bottom: 90px; left: 15px; } 
    }
  </style>
</head>
<body>

  <div id="login-overlay">
    <div class="login-box">
      <h2>SYSTEM LOGIN</h2>
      <input type="text" id="mqtt-user" class="input-field" placeholder="HiveMQ Username">
      <input type="password" id="mqtt-pass" class="input-field" placeholder="HiveMQ Password">
      <div style="font-size:12px; text-align:left; margin-top:5px;">
        <input type="checkbox" id="remember-me"> Remember Me
      </div>
      <button class="action-btn" onclick="connectSystem()">CONNECT</button>
    </div>
  </div>

  <div id="dashboard" style="display:none;">
    <header class="header">
      <strong>SMART MEZZA CONTROL</strong>
      <button onclick="doLogout()" style="background:none; border:1px solid #666; color:#ccc; padding:5px 10px; cursor:pointer;">EXIT</button>
    </header>

    <div class="container">
      <div class="sidebar">
        <div class="card">
          <h3>MASTER POWER (ID: 9)</h3>
          <div style="text-align:center; margin-bottom:10px;">
            <span id="led-9" class="led"></span> <b>System Bus</b>
          </div>
          <button id="btn-9" class="btn btn-on" onclick="handleClick(9)">TURN ON</button>
        </div>

        <div id="panel-lock" class="card disabled">
          <h3>CONTROL PANEL</h3>
          <div class="grid-2" id="relay-grid"></div>
        </div>
      </div>

      <div class="main-content">
        <div class="card">
          <h3>LIVE FEED</h3>
          <div class="camera-box">No Signal</div>
        </div>

        <div class="card">
          <h3>POWER MONITOR</h3>
          <div class="pzem-grid">
            <div><div id="val-v" class="pzem-val">0</div><div class="pzem-label">VOLTS</div></div>
            <div><div id="val-a" class="pzem-val">0.00</div><div class="pzem-label">AMPS</div></div>
            <div><div id="val-w" class="pzem-val">0</div><div class="pzem-label">WATTS</div></div>
            <div><div id="val-wh" class="pzem-val">0.00</div><div class="pzem-label">Wh</div></div>
          </div>
        </div>

        <div class="card" style="flex:1;">
          <h3>ACTIVITY LOG</h3>
          <div class="log-list">
            <table class="log-table">
              <thead>
                <tr><th>Time</th><th>Action</th><th>Target</th></tr>
              </thead>
              <tbody id="log-body"></tbody>
            </table>
          </div>
          <button onclick="clearLog()" style="width:100%; margin-top:5px; background:#ddd; border:none; padding:5px; cursor:pointer;">Clear History</button>
        </div>
      </div>
    </div>

    <button id="help-btn" onclick="openModal('tutorial-modal')">?</button>

    <footer>
      <span id="clock">--:--:--</span>
      <span>Temp: <b id="val-temp">--</b>°C</span>
      <span>Humi: <b id="val-humi">--</b>%</span>
    </footer>
  </div>

  <div id="tutorial-modal" class="modal-overlay">
    <div class="modal-box">
      <h3 style="color:#333;">SYSTEM GUIDE</h3>
      <p style="font-size:13px; text-align:left;"><b>1. Master Power:</b><br>Turns ON the main bus. Must be ON to control printers.</p>
      <p style="font-size:13px; text-align:left;"><b>2. Control Panel:</b><br>Toggle individual devices. Locked if Master is OFF.</p>
      <p style="font-size:13px; text-align:left;"><b>3. Safety:</b><br>Turning OFF requires typing "CONFIRM".</p>
      <button class="btn btn-on" onclick="closeModal('tutorial-modal')">GOT IT</button>
    </div>
  </div>

  <div id="confirm-modal" class="modal-overlay">
    <div class="modal-box">
      <h3 style="color:var(--danger)">⚠️ CONFIRM ACTION</h3>
      <p id="confirm-msg">Type CONFIRM to turn off.</p>
      <input type="text" id="confirm-input" class="input-field" style="text-align:center; color:black; background:#eee;" placeholder="Type CONFIRM">
      <div style="display:flex; gap:10px; margin-top:15px;">
        <button class="btn btn-off" onclick="executeOff()">CONFIRM OFF</button>
        <button class="btn btn-on" style="background:#ddd; color:#333; border:1px solid #ccc;" onclick="closeModal('confirm-modal')">CANCEL</button>
      </div>
    </div>
  </div>

<script>
const MQTT_HOST = "143fa294384e4a2fa42c7bfe8a7ebd1d.s1.eu.hivemq.cloud";
const MQTT_PORT = 8884;
const CLIENT_ID = "web_" + Math.random().toString(16).substr(2, 8);
const LABELS = ["Printer 1", "Printer 2", "Printer 3", "Printer 4", "LED", "Free 1", "Free 2", "Free 3"];

let client = null;
let deviceState = { 1:0, 2:0, 3:0, 4:0, 5:0, 6:0, 7:0, 8:0, 9:0 }; 
let pendingId = null; 
let lockTimer = 0; // Anti-Flicker Timestamp

// ================= INITIALIZATION =================
window.onload = () => {
  renderRelays();
  renderLogs(); // Load history on start
  const u = localStorage.getItem("mq_u");
  const p = localStorage.getItem("mq_p");
  if(u && p) { 
    document.getElementById("mqtt-user").value = u;
    document.getElementById("mqtt-pass").value = p;
    connectSystem();
  }
};

function renderRelays() {
  const container = document.getElementById("relay-grid");
  container.innerHTML = "";
  LABELS.forEach((name, index) => {
    const id = index + 1;
    container.innerHTML += `
      <div class="relay-item">
        <div><span id="led-${id}" class="led"></span> <b>${name}</b></div>
        <button id="btn-${id}" class="btn btn-on" onclick="handleClick(${id})">TURN ON</button>
      </div>`;
  });
}

// ================= LOG SYSTEM (PERSISTENT) =================
function addLog(action, target) {
  const newLog = {
    time: new Date().toLocaleTimeString(),
    action: action,
    target: target
  };

  // 1. Get Log History
  let history = JSON.parse(localStorage.getItem("sys_logs") || "[]");
  
  // 2. Add New Log to Top
  history.unshift(newLog);
  
  // 3. Trim to 100 items
  if (history.length > 100) history = history.slice(0, 100);
  
  // 4. Save
  localStorage.setItem("sys_logs", JSON.stringify(history));
  
  // 5. Render
  renderLogs();
}

function renderLogs() {
  let history = JSON.parse(localStorage.getItem("sys_logs") || "[]");
  const tbody = document.getElementById("log-body");
  
  if(history.length === 0) {
    tbody.innerHTML = "<tr><td colspan='3' style='text-align:center; color:#999'>No activity history</td></tr>";
    return;
  }

  tbody.innerHTML = history.map(log => `
    <tr>
      <td>${log.time}</td>
      <td>${log.action}</td>
      <td>${log.target}</td>
    </tr>
  `).join("");
}

function clearLog() {
  if(!confirm("Clear all history?")) return;
  localStorage.removeItem("sys_logs");
  renderLogs();
}

// ================= MQTT CONNECTION =================
function connectSystem() {
  const u = document.getElementById("mqtt-user").value;
  const p = document.getElementById("mqtt-pass").value;
  
  if(!u || !p) return alert("Credentials Required");

  if(document.getElementById("remember-me").checked) {
    localStorage.setItem("mq_u", u);
    localStorage.setItem("mq_p", p);
  }

  client = new Paho.MQTT.Client("wss://" + MQTT_HOST + ":" + MQTT_PORT + "/mqtt", CLIENT_ID);
  
  client.onMessageArrived = onMessage;
  
  client.connect({
    useSSL: true, userName: u, password: p,
    onSuccess: () => {
      document.getElementById("login-overlay").style.display = "none";
      document.getElementById("dashboard").style.display = "block";
      client.subscribe("/printer_01/status");
      addLog("System", "Connected");
    },
    onFailure: (e) => alert("Connection Failed: " + e.errorMessage)
  });
}

function onMessage(m) {
  // If user just clicked a button, ignore updates for 6 seconds (Prevents Flicker)
  if(Date.now() < lockTimer) return;

  try {
    const d = JSON.parse(m.payloadString);
    if(d.relays) d.relays.forEach((s, i) => updateState(i+1, s));
    if(d.master !== undefined) updateState(9, d.master);
    if(d.v) ['v','a','w','wh'].forEach(k => document.getElementById(`val-${k}`).innerText = d[k]);
    if(d.temp) document.getElementById("val-temp").innerText = d.temp;
    if(d.humi) document.getElementById("val-humi").innerText = d.humi;
  } catch(e) { console.error(e); }
}

// ================= LOGIC & CONTROL =================
function updateState(id, state) {
  state = Number(state);
  deviceState[id] = state; // Update Internal Memory

  const led = document.getElementById(`led-${id}`);
  const btn = document.getElementById(`btn-${id}`);
  
  if(state === 1) {
    led.classList.add("on");
    btn.innerText = "TURN OFF";
    btn.className = "btn btn-off";
    if(id === 9) document.getElementById("panel-lock").classList.remove("disabled");
  } else {
    led.classList.remove("on");
    btn.innerText = "TURN ON";
    btn.className = "btn btn-on";
    if(id === 9) document.getElementById("panel-lock").classList.add("disabled");
  }
}

function handleClick(id) {
  const currentState = deviceState[id]; // Use Internal Memory
  
  // IF ON -> ASK TO TURN OFF
  if(currentState === 1) {
    pendingId = id;
    const name = id === 9 ? "Master Bus" : LABELS[id-1];
    
    // Setup Modal
    const input = document.getElementById("confirm-input");
    const msg = document.getElementById("confirm-msg");
    
    if(id === 9) {
      msg.innerHTML = `Type <b>CONFIRM</b> to kill <b>${name}</b>`;
      input.style.display = "block";
      input.value = "";
    } else {
      msg.innerHTML = `Turn off <b>${name}</b>?`;
      input.style.display = "none";
    }
    
    openModal("confirm-modal");
  } 
  // IF OFF -> TURN ON IMMEDIATELY
  else {
    sendCommand(id, 1);
  }
}

function executeOff() {
  // If Master Bus, Check Password
  if(pendingId === 9) {
    const txt = document.getElementById("confirm-input").value;
    if(txt !== "CONFIRM") return alert("Please type CONFIRM");
  }
  
  sendCommand(pendingId, 0);
  closeModal("confirm-modal");
}

function sendCommand(id, state) {
  // 1. Lock incoming updates for 6s so UI doesn't flicker
  lockTimer = Date.now() + 6000;
  
  // 2. Update UI Immediately (Optimistic)
  updateState(id, state);
  
  // 3. Send MQTT
  const payload = JSON.stringify({ relay: id, state: state });
  const message = new Paho.MQTT.Message(payload);
  message.destinationName = "/printer_01/commands";
  client.send(message);
  
  // 4. Log it
  const name = id === 9 ? "Master Bus" : LABELS[id-1];
  addLog(state ? "ON" : "OFF", name);
}

// ================= HELPERS =================
function openModal(id) { document.getElementById(id).style.display = "flex"; }
function closeModal(id) { 
  document.getElementById(id).style.display = "none"; 
  pendingId = null; 
}

function doLogout() {
  localStorage.removeItem("mq_u");
  localStorage.removeItem("mq_p");
  location.reload();
}

setInterval(() => {
  document.getElementById("clock").innerText = new Date().toLocaleTimeString();
}, 1000);

</script>
</body>
</html>
