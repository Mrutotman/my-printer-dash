<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Smart 3D Printer Dash - SECURE</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', Arial; margin: 0; background-color: #f4f4f9; display: flex; flex-direction: column; height: 100vh; }
    
    /* Password Gatekeeper Styling */
    #auth-overlay {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: #1a1a1a;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      z-index: 10000;
      color: white;
    }
    .auth-box { background: #333; padding: 30px; border-radius: 12px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.5); border: 1px solid #444; }
    .auth-input { padding: 12px; font-size: 16px; border-radius: 6px; border: 1px solid #555; width: 220px; margin-bottom: 15px; text-align: center; background: #222; color: white; }
    .auth-btn { background: #4CAF50; color: white; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }
    .auth-btn:hover { background: #45a049; }

    /* Loading Screen Styling (Visible after login) */
    #loading-screen {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: #333;
      display: none; flex-direction: column;
      align-items: center; justify-content: center;
      z-index: 9999;
      color: white;
      transition: opacity 0.5s ease;
    }
    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top: 4px solid #4CAF50;
      width: 40px; height: 40px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* Layout Styling */
    header { background: #333; color: white; padding: 10px 20px; text-align: left; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    .main-container { display: flex; flex: 1; overflow: hidden; padding: 15px; gap: 20px; }
    .sidebar { width: 40%; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
    .monitoring { width: 60%; display: flex; flex-direction: column; gap: 15px; }
    .section { background: white; border-radius: 12px; padding: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .relay-card { border: 1px solid #eee; padding: 10px; border-radius: 8px; background: #fafafa; text-align: center; }
    .btn { font-size: 13px; padding: 10px; margin-top: 8px; border: none; border-radius: 6px; cursor: pointer; width: 100%; font-weight: bold; transition: 0.3s; }
    .on { background-color: #4CAF50; color: white; }
    .off { background-color: #f44336; color: white; }
    .master-btn { font-size: 16px; padding: 15px; }
    .status-text { font-weight: bold; font-size: 14px; }
    .green { color: #2e7d32; }
    .red { color: #c62828; }
    
    .test-readout { display: flex; justify-content: space-around; padding: 15px 0; text-align: center; }
    .test-val { font-size: 28px; font-weight: bold; color: #333; }
    .test-label { font-size: 11px; color: #777; text-transform: uppercase; margin-top: 5px; }

    .placeholder { border: 2px dashed #ccc; color: #999; display: flex; align-items: center; justify-content: center; min-height: 250px; font-style: italic; background: #ebebef; }
    #help-btn { position: fixed; bottom: 20px; left: 20px; width: 40px; height: 40px; border-radius: 50%; background: #333; color: white; font-weight: bold; font-size: 20px; border: none; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.3); z-index: 1000; }
    .modal { display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; }
    .modal-content { background: white; padding: 25px; border-radius: 12px; max-width: 400px; text-align: center; }
    .modal-btns { display: flex; gap: 10px; justify-content: center; margin-top: 20px; }
    #cloud-bar { background: #222; color: #00ff00; font-size: 11px; padding: 3px 20px; text-align: right; }
  </style>
</head>
<body>

  <div id="auth-overlay">
    <div class="auth-box">
      <h2>üîí Secure Access</h2>
      <p>Enter Password to Control Farm</p>
      <input type="password" id="pass-input" class="auth-input" placeholder="Password"><br>
      <button class="auth-btn" onclick="checkPassword()">UNLOCK DASHBOARD</button>
      <p id="auth-error" style="color: #ff4444; font-size: 12px; margin-top: 10px; display: none;">Incorrect Password!</p>
    </div>
  </div>

  <div id="loading-screen">
    <div class="spinner"></div>
    <div id="loading-text">Connecting to Printer Farm Cloud...</div>
  </div>

  <div id="main-content" style="display: none;">
    <div id="cloud-bar">SYNCING...</div>
    <header><h2>SMART 3D PRINTER DASHBOARD (GLOBAL)</h2></header>

    <div class="main-container">
      <div class="sidebar">
        <div class="section">
          <h3>MASTER POWER</h3>
          <p>Status: <span id="relay9_status" class="status-text red">OFF</span></p>
          <button id="relay9_btn" class="btn master-btn on" onclick="handleRelayAction(9)">TURN MASTER ON</button>
        </div>
        <div class="section">
          <h3>CONTROL PANEL</h3>
          <div class="grid" id="relay-container"></div>
        </div>
      </div>

      <div class="monitoring">
        <div class="section"><h3>CAMERA FEED</h3><div class="placeholder">Stream Output...</div></div>
        
        <div class="section">
          <h3>ENERGY MONITORING (PZEM - DHT TEST)</h3>
          <div class="test-readout">
            <div>
              <div id="temp-display" class="test-val">--¬∞C</div>
              <div class="test-label">Temperature</div>
            </div>
            <div style="width: 1px; background: #eee;"></div>
            <div>
              <div id="humi-display" class="test-val">--%</div>
              <div class="test-label">Humidity</div>
            </div>
          </div>
          <p style="text-align: center; color: #999; font-size: 11px; margin-top: 10px;"><i>Power data will replace these readings once PZEM is integrated.</i></p>
        </div>
      </div>
    </div>

    <button id="help-btn" onclick="toggleModal('tutorial-modal')">?</button>

    <div id="warning-modal" class="modal">
      <div class="modal-content">
        <h3 style="color:#c62828">‚ö†Ô∏è WARNING</h3>
        <p id="warning-text">Confirm Action?</p>
        <div class="modal-btns">
          <button class="btn on" style="width: 80px;" onclick="confirmAction()">YES</button>
          <button class="btn off" style="width: 80px;" onclick="closeModals()">NO</button>
        </div>
      </div>
    </div>

    <div id="tutorial-modal" class="modal">
      <div class="modal-content" style="text-align: left;">
        <h3 style="text-align:center">Tutorial & Help</h3>
        <p><b>1. Master Power:</b> Must be ON before individual printers start.</p>
        <p><b>2. Global Dash:</b> Access your farm from any network.</p>
        <p><b>3. Sensor Test:</b> Environmental data is currently displayed in the Energy section.</p>
        <button class="btn on" onclick="closeModals()">GOT IT</button>
      </div>
    </div>
  </div>

<script>
// --- AUTHENTICATION LOGIC ---
const SECRET_PASS = "PUP_Engineering_2026"; // Change this to your preferred password

function checkPassword() {
  const input = document.getElementById('pass-input').value;
  if (input === SECRET_PASS) {
    document.getElementById('auth-overlay').style.display = 'none';
    document.getElementById('main-content').style.display = 'block';
    document.getElementById('loading-screen').style.display = 'flex';
    initMQTT(); // Connect only after correct password
  } else {
    document.getElementById('auth-error').style.display = 'block';
    document.getElementById('pass-input').value = "";
  }
}

// Press Enter to Login
document.getElementById('pass-input').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') checkPassword();
});

// --- DASHBOARD LOGIC ---
let pendingId = null;
const MQTT_HOST = "143fa294384e4a2fa42c7bfe8a7ebd1d.s1.eu.hivemq.cloud";
const MQTT_PORT = 8884; 
const MQTT_USER = "hivemq.webclient.1769879772484";
const MQTT_PASS = "e9GHjk0b18hiCBAD%<$!";
const CLIENT_ID = "web_ui_" + Math.random().toString(16).substr(2, 8);

const client = new Paho.MQTT.Client("wss://" + MQTT_HOST + ":" + MQTT_PORT + "/mqtt", CLIENT_ID);

function initMQTT() {
  client.connect({
    useSSL: true, userName: MQTT_USER, password: MQTT_PASS,
    onSuccess: () => {
      document.getElementById('cloud-bar').innerText = "GLOBAL CLOUD: CONNECTED";
      client.subscribe("/printer_01/status");
      setTimeout(hideLoading, 2000);
    },
    onFailure: () => {
      document.getElementById('loading-text').innerText = "Connection Failed. Refreshing...";
      setTimeout(() => location.reload(), 3000);
    }
  });
}

client.onMessageArrived = (message) => {
  try {
    const data = JSON.parse(message.payloadString);
    if(data.relays) data.relays.forEach((state, index) => updateUI(index + 1, state));
    if(data.hasOwnProperty('master')) updateUI(9, data.master);
    if(data.hasOwnProperty('temp')) document.getElementById('temp-display').innerText = data.temp.toFixed(1) + "¬∞C";
    if(data.hasOwnProperty('humi')) document.getElementById('humi-display').innerText = data.humi.toFixed(1) + "%";
    hideLoading();
  } catch(e) { console.error(e); }
};

function hideLoading() {
  const loader = document.getElementById('loading-screen');
  loader.style.opacity = '0';
  setTimeout(() => loader.style.display = 'none', 500);
}

// Generate UI
const container = document.getElementById('relay-container');
const labels = ["Printer 1", "Printer 2", "Printer 3", "Printer 4", "Free 1", "Free 2", "LED Light", "Spare"];
for (let i = 1; i <= 8; i++) {
  container.innerHTML += `
    <div class="relay-card">
      <small style="color: #666;">${labels[i-1]}</small><br>
      <span id="relay${i}_status" class="status-text red">OFF</span><br>
      <button id="relay${i}_btn" class="btn on" onclick="handleRelayAction(${i})">ON</button>
    </div>`;
}

function handleRelayAction(id) {
  const statusEl = document.getElementById(`relay${id}_status`);
  const isCurrentlyOn = statusEl.innerText.includes("ON");
  if (isCurrentlyOn) {
    pendingId = id;
    document.getElementById('warning-text').innerText = (id === 9) ? "Turning off Master will kill ALL printers. Continue?" : "Are you sure you want to turn off " + labels[id-1] + "?";
    toggleModal('warning-modal');
  } else {
    sendMqttCmd(id, 1);
  }
}

function confirmAction() {
  if (pendingId !== null) sendMqttCmd(pendingId, 0);
  closeModals();
}

function sendMqttCmd(id, state) {
  const msg = new Paho.MQTT.Message(JSON.stringify({relay: id, state: state}));
  msg.destinationName = "/printer_01/commands";
  client.send(msg);
  pendingId = null;
}

function updateUI(id, state) {
  const statusEl = document.getElementById(`relay${id}_status`);
  const btnEl = document.getElementById(`relay${id}_btn`);
  if(!statusEl || !btnEl) return;
  
  if (state == 1) {
    statusEl.innerHTML = "ON"; statusEl.className = "status-text green";
    btnEl.innerHTML = (id === 9) ? "TURN MASTER OFF" : "TURN OFF";
    btnEl.className = (id === 9) ? "btn master-btn off" : "btn off";
  } else {
    statusEl.innerHTML = "OFF"; statusEl.className = "status-text red";
    btnEl.innerHTML = (id === 9) ? "TURN MASTER ON" : "TURN ON";
    btnEl.className = (id === 9) ? "btn master-btn on" : "btn on";
  }
}

function toggleModal(id) { document.getElementById(id).style.display = 'flex'; }
function closeModals() { 
  document.getElementById('warning-modal').style.display = 'none'; 
  document.getElementById('tutorial-modal').style.display = 'none'; 
}
</script>
</body>
</html>
